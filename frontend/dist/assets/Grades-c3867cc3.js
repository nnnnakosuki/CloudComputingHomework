import{b as K,s as Pe,a as Ke,d as Qe}from"./grade-b0111342.js";import{a as Re}from"./courseSchedule-2f0830e1.js";import{a as Je}from"./courseSelection-a3ee75e2.js";import{a as oe,r as p,b as Q,j as L,z as Oe,k as We,c as u,v as Xe,o as b,d as R,f as t,w as l,n as w,m as I,E as c,e as s,h as m,F as Ze,q as et,x as se,t as x,y as tt,p as ne}from"./index-9b5da449.js";import{_ as lt}from"./_plugin-vue_export-helper-c27b6911.js";const at={class:"grade-input"},ot={class:"card-header"},st={key:1,class:"batch-actions"},nt={class:"stat-content"},ut={class:"stat-icon total"},dt={class:"stat-info"},rt={class:"stat-content"},it={class:"stat-icon submitted"},ct={class:"stat-info"},mt={class:"stat-content"},pt={class:"stat-icon pending"},ft={class:"stat-info"},vt={class:"stat-content"},_t={class:"stat-icon average"},gt={class:"stat-info"},ht={style:{"margin-bottom":"20px"}},yt={__name:"Grades",setup(bt){const ue=oe(),$=p(!1),Y=p(!1);p(!1);const H=p(!1),J=p([]),C=p([]),f=p([]),j=p([]),N=p(!1),T=p(!1),E=p(!1),U=p(!1),M=p([]),A=p(!1),B=p(""),y=Q({current:1,size:10,total:0}),v=p({id:null,studentNo:"",studentName:"",courseName:"",score:null}),q=p(!1),i=Q({courseScheduleId:null}),g=Q({startTime:"",endTime:""}),de=L(()=>"/api/grades/import"),re=L(()=>{const e=oe().token||localStorage.getItem("token")||"";return console.log("Upload headers:",{token:e?"has token":"no token",tokenLength:e==null?void 0:e.length}),{Authorization:e?`Bearer ${e}`:""}}),ie=L(()=>f.value.filter(a=>a.score).length),ce=L(()=>f.value.filter(a=>!a.score).length),me=L(()=>{const a=f.value.filter(n=>n.score).map(n=>parseFloat(n.score));return a.length===0?"0.0":(a.reduce((n,d)=>n+d,0)/a.length).toFixed(1)}),pe=async()=>{try{const a=ue.userInfo.id,e=await Re({teacherId:a});J.value=e.data.records||[]}catch{c.error("获取课程列表失败")}},O=async()=>{var a,e;if(i.courseScheduleId){$.value=!0;try{const d=(await Je({courseScheduleId:i.courseScheduleId,status:2})).data.records||[];C.value=d.map(r=>({studentId:r.studentId,studentNo:r.studentNo,studentName:r.studentName,className:r.className||"",major:r.major||"",score:r.score||""})),f.value=C.value.map(r=>({studentId:r.studentId,courseScheduleId:i.courseScheduleId,score:r.score||"",remark:""}))}catch(n){console.error("加载学生名单失败:",n),c.error("加载学生名单失败: "+(((e=(a=n.response)==null?void 0:a.data)==null?void 0:e.message)||n.message))}finally{$.value=!1}}},fe=()=>{C.value=[],f.value=[]},ve=(a,e)=>{const n=parseFloat(f.value[e].score);(n<0||n>100)&&(c.warning("成绩应在0-100之间"),f.value[e].score="")},_e=async(a,e)=>{const n=f.value[e];if(!n.score){c.warning("请输入成绩");return}try{await K(i.courseScheduleId,[n]),c.success("成绩提交成功")}catch{c.error("成绩提交失败")}},ge=async()=>{const a=f.value.filter(e=>e.score);if(a.length===0){c.warning("没有可提交的成绩");return}try{await ne.confirm(`确定要提交 ${a.length} 个学生的成绩吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),Y.value=!0,await K(i.courseScheduleId,a),c.success("批量提交成绩成功")}catch(e){e!=="cancel"&&c.error("批量提交成绩失败")}finally{Y.value=!1}},he=()=>{f.value.forEach(a=>{a.score="",a.remark=""}),c.success("已清空所有成绩")},ye=a=>{j.value=[a]},be=()=>{j.value=[]},Se=(a,e,n)=>{c.success(a.message||"成绩导入成功"),N.value=!1,i.courseScheduleId&&O()},we=a=>{console.error("上传失败:",a),c.error("成绩导入失败，请检查文件格式或网络连接")},Ce=async()=>{var a,e;if(!g.startTime||!g.endTime){c.warning("请选择完整的时段");return}if(g.startTime>=g.endTime){c.warning("开始时间必须早于结束时间");return}H.value=!0;try{await Pe(i.courseScheduleId,g.startTime,g.endTime),c.success("查询时段设置成功"),T.value=!1}catch(n){c.error("设置失败: "+(((e=(a=n.response)==null?void 0:a.data)==null?void 0:e.message)||n.message))}finally{H.value=!1}},Ve=()=>{g.startTime="",g.endTime=""},ke=()=>{B.value="",M.value=[]},V=async()=>{if(i.courseScheduleId){A.value=!0;try{const a=await Ke({current:y.current,size:y.size,courseScheduleId:i.courseScheduleId,keyword:B.value});M.value=a.data.records||[],y.total=a.data.total||0}catch{c.error("加载成绩列表失败")}finally{A.value=!1}}},Ie=a=>{y.size=a,V()},xe=a=>{y.current=a,V()},Ne=a=>{v.value={id:a.id,studentNo:a.studentNo,studentName:a.studentName,courseName:a.courseName,score:parseFloat(a.score)},U.value=!0},Te=async()=>{var a,e,n;if(!v.value.score||v.value.score<0||v.value.score>100){c.warning("成绩必须在0-100之间");return}q.value=!0;try{await K(i.courseScheduleId,[{studentId:(a=M.value.find(d=>d.id===v.value.id))==null?void 0:a.studentId,courseScheduleId:i.courseScheduleId,score:v.value.score}]),c.success("成绩更新成功"),U.value=!1,V()}catch(d){c.error("更新失败: "+(((n=(e=d.response)==null?void 0:e.data)==null?void 0:n.message)||d.message))}finally{q.value=!1}},Ue=a=>{ne.confirm("确定要删除这条成绩记录吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{var e,n;try{await Qe(a.id),c.success("删除成功"),V()}catch(d){c.error("删除失败: "+(((n=(e=d.response)==null?void 0:e.data)==null?void 0:n.message)||d.message))}}).catch(()=>{})},ze=a=>a?a>=90?"score-excellent":a>=80?"score-good":a>=70?"score-medium":a>=60?"score-pass":"score-fail":"score-empty",De=a=>{switch(a){case 1:return"warning";case 2:return"success";case 3:return"danger";default:return"info"}};return Oe(E,a=>{a&&i.courseScheduleId&&V()}),We(()=>{pe()}),(a,e)=>{const n=u("DocumentCopy"),d=u("el-icon"),r=u("el-button"),W=u("Upload"),X=u("Clock"),Le=u("el-option"),Ee=u("el-select"),S=u("el-form-item"),Z=u("Search"),P=u("el-form"),_=u("el-table-column"),k=u("el-input"),ee=u("el-table"),te=u("Delete"),z=u("el-card"),Me=u("User"),F=u("el-col"),Be=u("Check"),Fe=u("TrendCharts"),Ge=u("el-row"),$e=u("upload-filled"),Ye=u("el-upload"),G=u("el-dialog"),le=u("el-date-picker"),He=u("el-tag"),je=u("Edit"),Ae=u("el-pagination"),qe=u("el-input-number"),ae=Xe("loading");return b(),R("div",at,[t(z,null,{header:l(()=>[s("div",ot,[e[23]||(e[23]=s("span",null,"成绩管理",-1)),s("div",null,[i.courseScheduleId?(b(),w(r,{key:0,type:"primary",onClick:e[0]||(e[0]=o=>E.value=!0)},{default:l(()=>[t(d,null,{default:l(()=>[t(n)]),_:1}),e[20]||(e[20]=m(" 查看已录入成绩 ",-1))]),_:1})):I("",!0),i.courseScheduleId?(b(),w(r,{key:1,type:"info",onClick:e[1]||(e[1]=o=>N.value=!0)},{default:l(()=>[t(d,null,{default:l(()=>[t(W)]),_:1}),e[21]||(e[21]=m(" 导入成绩文件 ",-1))]),_:1})):I("",!0),i.courseScheduleId?(b(),w(r,{key:2,type:"warning",onClick:e[2]||(e[2]=o=>T.value=!0)},{default:l(()=>[t(d,null,{default:l(()=>[t(X)]),_:1}),e[22]||(e[22]=m(" 设置查询时段 ",-1))]),_:1})):I("",!0)])])]),default:l(()=>[t(P,{model:i,inline:"",class:"search-form"},{default:l(()=>[t(S,{label:"选择课程"},{default:l(()=>[t(Ee,{modelValue:i.courseScheduleId,"onUpdate:modelValue":e[3]||(e[3]=o=>i.courseScheduleId=o),placeholder:"请选择课程",onChange:fe,style:{width:"300px"},filterable:""},{default:l(()=>[(b(!0),R(Ze,null,et(J.value,o=>(b(),w(Le,{key:o.id,label:`${o.courseName} (${o.semester||""})`,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(S,null,{default:l(()=>[t(r,{type:"primary",onClick:O,disabled:!i.courseScheduleId},{default:l(()=>[t(d,null,{default:l(()=>[t(Z)]),_:1}),e[24]||(e[24]=m(" 加载学生名单 ",-1))]),_:1},8,["disabled"])]),_:1})]),_:1},8,["model"]),i.courseScheduleId?se((b(),w(ee,{key:0,data:C.value,stripe:"",style:{width:"100%"}},{default:l(()=>[t(_,{prop:"studentNo",label:"学号",width:"120"}),t(_,{prop:"studentName",label:"姓名",width:"100"}),t(_,{prop:"className",label:"班级",width:"120"}),t(_,{prop:"major",label:"专业",width:"150"}),t(_,{label:"成绩",width:"150"},{default:l(({row:o,$index:h})=>[t(k,{modelValue:f.value[h].score,"onUpdate:modelValue":D=>f.value[h].score=D,placeholder:"请输入成绩",type:"number",min:0,max:100,onInput:D=>ve(o,h)},null,8,["modelValue","onUpdate:modelValue","onInput"])]),_:1}),t(_,{label:"备注",width:"200"},{default:l(({row:o,$index:h})=>[t(k,{modelValue:f.value[h].remark,"onUpdate:modelValue":D=>f.value[h].remark=D,placeholder:"请输入备注"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),t(_,{label:"操作",width:"100"},{default:l(({row:o,$index:h})=>[t(r,{type:"primary",size:"small",onClick:D=>_e(o,h),disabled:!f.value[h].score},{default:l(()=>[...e[25]||(e[25]=[m(" 提交 ",-1)])]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["data"])),[[ae,$.value]]):I("",!0),i.courseScheduleId&&C.value.length>0?(b(),R("div",st,[t(r,{type:"success",onClick:ge,loading:Y.value},{default:l(()=>[t(d,null,{default:l(()=>[t(W)]),_:1}),e[26]||(e[26]=m(" 批量提交成绩 ",-1))]),_:1},8,["loading"]),t(r,{onClick:he},{default:l(()=>[t(d,null,{default:l(()=>[t(te)]),_:1}),e[27]||(e[27]=m(" 清空所有 ",-1))]),_:1})])):I("",!0)]),_:1}),i.courseScheduleId?(b(),w(Ge,{key:0,gutter:20,style:{"margin-top":"20px"}},{default:l(()=>[t(F,{span:6},{default:l(()=>[t(z,{class:"stat-card"},{default:l(()=>[s("div",nt,[s("div",ut,[t(d,null,{default:l(()=>[t(Me)]),_:1})]),s("div",dt,[s("h3",null,x(C.value.length),1),e[28]||(e[28]=s("p",null,"总学生数",-1))])])]),_:1})]),_:1}),t(F,{span:6},{default:l(()=>[t(z,{class:"stat-card"},{default:l(()=>[s("div",rt,[s("div",it,[t(d,null,{default:l(()=>[t(Be)]),_:1})]),s("div",ct,[s("h3",null,x(ie.value),1),e[29]||(e[29]=s("p",null,"已录入",-1))])])]),_:1})]),_:1}),t(F,{span:6},{default:l(()=>[t(z,{class:"stat-card"},{default:l(()=>[s("div",mt,[s("div",pt,[t(d,null,{default:l(()=>[t(X)]),_:1})]),s("div",ft,[s("h3",null,x(ce.value),1),e[30]||(e[30]=s("p",null,"待录入",-1))])])]),_:1})]),_:1}),t(F,{span:6},{default:l(()=>[t(z,{class:"stat-card"},{default:l(()=>[s("div",vt,[s("div",_t,[t(d,null,{default:l(()=>[t(Fe)]),_:1})]),s("div",gt,[s("h3",null,x(me.value),1),e[31]||(e[31]=s("p",null,"平均分",-1))])])]),_:1})]),_:1})]),_:1})):I("",!0),t(G,{modelValue:N.value,"onUpdate:modelValue":e[5]||(e[5]=o=>N.value=o),title:"导入成绩文件",width:"600px",onClose:be},{footer:l(()=>[t(r,{onClick:e[4]||(e[4]=o=>N.value=!1)},{default:l(()=>[...e[34]||(e[34]=[m("关闭",-1)])]),_:1})]),default:l(()=>[t(Ye,{ref:"uploadRef",class:"upload-demo",drag:"",action:de.value,"auto-upload":!0,"on-success":Se,"on-error":we,"on-change":ye,"file-list":j.value,limit:1,accept:".xlsx,.csv",headers:re.value},{tip:l(()=>[...e[32]||(e[32]=[s("div",{class:"el-upload__tip"},[m(" 支持上传Excel(.xlsx)和CSV(.csv)文件"),s("br"),m(" 文件格式：学号、学生姓名、课程、分数、学期 ")],-1)])]),default:l(()=>[t(d,{class:"el-icon--upload"},{default:l(()=>[t($e)]),_:1}),e[33]||(e[33]=s("div",{class:"el-upload__text"},[m(" 将文件拖到此处，或"),s("em",null,"点击上传")],-1))]),_:1},8,["action","file-list","headers"])]),_:1},8,["modelValue"]),t(G,{modelValue:T.value,"onUpdate:modelValue":e[9]||(e[9]=o=>T.value=o),title:"设置成绩查询时段",width:"500px",onClose:Ve},{footer:l(()=>[t(r,{onClick:e[8]||(e[8]=o=>T.value=!1)},{default:l(()=>[...e[35]||(e[35]=[m("取消",-1)])]),_:1}),t(r,{type:"primary",onClick:Ce,loading:H.value},{default:l(()=>[...e[36]||(e[36]=[m(" 确定 ",-1)])]),_:1},8,["loading"])]),default:l(()=>[t(P,{model:g,"label-width":"120px"},{default:l(()=>[t(S,{label:"开始时间"},{default:l(()=>[t(le,{modelValue:g.startTime,"onUpdate:modelValue":e[6]||(e[6]=o=>g.startTime=o),type:"datetime",placeholder:"选择开始时间",style:{width:"100%"},"value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1}),t(S,{label:"结束时间"},{default:l(()=>[t(le,{modelValue:g.endTime,"onUpdate:modelValue":e[7]||(e[7]=o=>g.endTime=o),type:"datetime",placeholder:"选择结束时间",style:{width:"100%"},"value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(G,{modelValue:E.value,"onUpdate:modelValue":e[13]||(e[13]=o=>E.value=o),title:"成绩管理",width:"900px",onClose:ke},{footer:l(()=>[t(Ae,{"current-page":y.current,"onUpdate:currentPage":e[11]||(e[11]=o=>y.current=o),"page-size":y.size,"onUpdate:pageSize":e[12]||(e[12]=o=>y.size=o),total:y.total,"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next",onSizeChange:Ie,onCurrentChange:xe},null,8,["current-page","page-size","total"])]),default:l(()=>[s("div",ht,[t(k,{modelValue:B.value,"onUpdate:modelValue":e[10]||(e[10]=o=>B.value=o),placeholder:"搜索学号、姓名",clearable:"",style:{width:"300px"},onInput:V},{prefix:l(()=>[t(d,null,{default:l(()=>[t(Z)]),_:1})]),_:1},8,["modelValue"])]),se((b(),w(ee,{data:M.value,stripe:"",style:{width:"100%"},"max-height":"400"},{default:l(()=>[t(_,{prop:"studentNo",label:"学号",width:"120"}),t(_,{prop:"studentName",label:"姓名",width:"100"}),t(_,{prop:"courseName",label:"课程",width:"150"}),t(_,{prop:"score",label:"成绩",width:"100"},{default:l(({row:o})=>[s("span",{class:tt(ze(o.score))},x(o.score||"未录入"),3)]),_:1}),t(_,{prop:"semester",label:"学期",width:"100"}),t(_,{prop:"submitTime",label:"提交时间",width:"160"}),t(_,{prop:"auditStatusText",label:"审核状态",width:"100"},{default:l(({row:o})=>[t(He,{type:De(o.auditStatus)},{default:l(()=>[m(x(o.auditStatusText||"未审核"),1)]),_:2},1032,["type"])]),_:1}),t(_,{label:"操作",width:"200",fixed:"right"},{default:l(({row:o})=>[t(r,{type:"primary",size:"small",onClick:h=>Ne(o)},{default:l(()=>[t(d,null,{default:l(()=>[t(je)]),_:1}),e[37]||(e[37]=m(" 编辑 ",-1))]),_:1},8,["onClick"]),t(r,{type:"danger",size:"small",onClick:h=>Ue(o)},{default:l(()=>[t(d,null,{default:l(()=>[t(te)]),_:1}),e[38]||(e[38]=m(" 删除 ",-1))]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ae,A.value]])]),_:1},8,["modelValue"]),t(G,{modelValue:U.value,"onUpdate:modelValue":e[19]||(e[19]=o=>U.value=o),title:"编辑成绩",width:"500px"},{footer:l(()=>[t(r,{onClick:e[18]||(e[18]=o=>U.value=!1)},{default:l(()=>[...e[39]||(e[39]=[m("取消",-1)])]),_:1}),t(r,{type:"primary",onClick:Te,loading:q.value},{default:l(()=>[...e[40]||(e[40]=[m(" 保存 ",-1)])]),_:1},8,["loading"])]),default:l(()=>[t(P,{model:v.value,"label-width":"100px"},{default:l(()=>[t(S,{label:"学号"},{default:l(()=>[t(k,{modelValue:v.value.studentNo,"onUpdate:modelValue":e[14]||(e[14]=o=>v.value.studentNo=o),disabled:""},null,8,["modelValue"])]),_:1}),t(S,{label:"姓名"},{default:l(()=>[t(k,{modelValue:v.value.studentName,"onUpdate:modelValue":e[15]||(e[15]=o=>v.value.studentName=o),disabled:""},null,8,["modelValue"])]),_:1}),t(S,{label:"课程"},{default:l(()=>[t(k,{modelValue:v.value.courseName,"onUpdate:modelValue":e[16]||(e[16]=o=>v.value.courseName=o),disabled:""},null,8,["modelValue"])]),_:1}),t(S,{label:"成绩",required:""},{default:l(()=>[t(qe,{modelValue:v.value.score,"onUpdate:modelValue":e[17]||(e[17]=o=>v.value.score=o),min:0,max:100,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},It=lt(yt,[["__scopeId","data-v-ef890698"]]);export{It as default};
